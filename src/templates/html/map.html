  <script>
    var map;

// Center the maps in Rome and zooming all region
    var mapLat = 41.9028;
    var mapLng = 12.4964;
    var mapDefaultZoom = 10;


    function initialize_map() {
      map = new ol.Map({
        target: "map",
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM({
                      url: "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"
                })
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([mapLng, mapLat]),
            zoom: mapDefaultZoom
        })
      });
    }
    function add_map_point(wkt, desc, url, img) {
// Parsing WTK record
	var format = new ol.format.WKT();
	var mfeature = format.readFeature(wkt);

// Prepare record on Map adding informations about Object-description-url-img
      var vectorLayer = new ol.layer.Vector({
        source:new ol.source.Vector({
          features: [new ol.Feature({
                type: 'click',
                desc: desc,
                url: url,
                image: img,
                geometry: mfeature.getGeometry().transform('EPSG:4326', 'EPSG:3857'),
            })]
        })
    });
      map.addLayer(vectorLayer);
      var popup = new ol.Overlay.Popup();
      map.addOverlay(popup);

// Add an event handler for when someone clicks on a marker
      map.on('singleclick', function(evt) {

// Hide existing popup and reset it's offset
       popup.hide();
       popup.setOffset([0, 0]);

// Attempt to find a feature in one of the visible vector layers
       var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            return feature;
                });
            if (feature) {
                var coord = feature.getGeometry().getCoordinates();
                var props = feature.getProperties();
                var info = '<a style="color:black; font-weight:600; font-size:11px" href="' + props.url + '">' +
                '<img width="200" src="' +  props.image + '"  />' +
                '<div style="width:220px; margin-top:3px">' + props.desc + '</div></a>';

// Offset the popup so it points at the middle of the marker not the tip
                popup.setOffset([0, -22]);
                popup.show(coord, info);
            }
        });

// Add an event handler for when someone hovers over a marker
// This changes the cursor to a pointer
        map.on("pointermove", function (evt) {
            var hit = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                return true;
            });
            if (hit) {
                this.getTargetElement().style.cursor = 'pointer';
            } else {
                this.getTargetElement().style.cursor = '';
            }
        });
    }
  </script>

<div id="map"></div>

<script>

    {% autoescape 'js' %}
        initialize_map();

        {% for resultType in results|keys %}
            {% for item in results[resultType] %}
                {% if item.wktGeometry %}
                    add_map_point('{{item.wktGeometry|replace({"<http://www.opengis.net/def/crs/OGC/1.3/CRS84>": ""})|trim|raw}}', '{{item.title}}', '{{item.item}}', '{{item.imageURL}}');
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endautoescape %}
</script>
